### 如何理解 nodejs 的不同阶段与宏任务队列

在 Node.js 中，宏任务队列并不是一个单一的队列，而是由多个不同的阶段组成，每个阶段都有自己的任务队列。

这些阶段共同组成了事件循环（Event Loop）。每个阶段负责处理特定类型的任务或回调，通常我们会把这些不同类型的任务队列称为“宏任务队列”。

#### Node.js 事件循环中的阶段和宏任务队列

1. timers 阶段：

处理 setTimeout 和 setInterval 的回调。
这些回调会放在 timers 阶段的任务队列中，并在设定的时间到期后执行。

2. pending callbacks 阶段：

处理一些系统操作的回调，例如某些 I/O 操作的回调，这些操作并不会立即执行，而是需要在适当的时机执行。
这类回调会放在 pending callbacks 阶段的任务队列中。

3. idle, prepare 阶段：

这个阶段主要是供 Node.js 内部使用的，在正常开发中基本不会涉及。可以理解为为准备和执行一些内部任务而保留的阶段。

4. poll 阶段：

这个阶段非常重要，它负责处理大多数的 I/O 操作，例如读取文件、网络请求等。
poll 阶段有一个 I/O 回调任务队列，通常会在这个阶段等待新的 I/O 事件到来。
如果有待处理的 I/O 回调，poll 阶段会执行这些回调。如果没有 I/O 回调等待执行，事件循环可能会在这个阶段暂停并等待新的事件。

5. check 阶段：

处理 setImmediate 的回调。
setImmediate 的回调会放在 check 阶段的任务队列中，并在当前事件循环的 poll 阶段之后立即执行。

6. close callbacks 阶段：

处理一些 close 事件的回调，例如 socket.on('close') 等。
这些回调会放在 close callbacks 阶段的任务队列中。

##### 宏任务队列的数量

从上述描述可以看出，Node.js 中的宏任务队列并不是一个单一的队列，而是多个队列，每个事件循环阶段都有自己的宏任务队列。

因此，可以说 **Node.js 事件循环中有多个宏任务队列，分别对应不同的阶段**。

总结来说，Node.js 中有 多个 宏任务队列，每个阶段（例如 timers、poll、check 等）都有各自独立的任务队列，这些任务队列共同构成了整个事件循环的执行流程。
